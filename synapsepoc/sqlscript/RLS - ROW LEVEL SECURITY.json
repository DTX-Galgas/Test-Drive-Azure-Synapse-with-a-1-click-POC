{
	"name": "RLS - ROW LEVEL SECURITY",
	"properties": {
		"content": {
			"query": "--DEMO DE ROW LEVEL SECURITY\n\n--To see how it works first we will create a test table and insert some sample values.\n\nCreate  table dbo.Orders\n(\nSupplier_Code int,\n[Supplier_name] varchar(10),\n[Orderdate] datetime,\n[OrderQuantity] int,\n[ProcessedBy] Varchar(10)\n)           \n \n -- Sample data\nInsert into dbo.Orders values(101,'AXP Inc','2015-08-11 00:34:51:090',1789,'RENAN')\nInsert into dbo.Orders values(102,'VFG Inc','2014-01-08 19:44:51:090',767,'MAIA')\nInsert into dbo.Orders values(103,'ZAD Inc','2015-08-19 19:44:51:090',500,'IAGO')\nInsert into dbo.Orders values(102,'VFG Inc','2014-08-19 19:44:51:090',1099,'IAGO')\nInsert into dbo.Orders values(101,'AXP Inc','2014-08-04 19:44:51:090',654,'RENAN')\nInsert into dbo.Orders values(103,'ZAD Inc','2015-08-10 19:44:51:090',498,'RENAN')\nInsert into dbo.Orders values(102,'VFG Inc','2015-04-17 19:44:51:090',999,'RENAN')\nInsert into dbo.Orders values(101,'AXP Inc','2015-08-21 19:44:51:090',543,'RENAN')\nInsert into dbo.Orders values(103,'ZAD Inc','2015-08-06 19:44:51:090',876,'RENAN')\nInsert into dbo.Orders values(102,'VFG Inc','2015-08-26 19:44:51:090',665,'RENAN')\n\n--See the data\nSelect * from dbo.Orders\n\n----------\n--Based on our requirements, we will create a predicate function:\n\nCreate Function fn_securitypredicateOrder (@processedby sysname)\nreturns table\nwith Schemabinding\nas\nreturn select 1 as [fn_securityPredicateOrder_result]\nfrom \ndbo.orders\nwhere @processedby = user_name()  -- it will be Filter applied while running the query\n\n--In the next step we need to define a Security Policy that will use the predicate function created above:\n\nCreate security Policy fn_security\nadd Filter Predicate dbo.fn_securitypredicateOrder(processedby)\non dbo.Orders\nWITH (STATE = ON); \n\n--CREATE THE USER AND PERMISSIONS\n-- trocar para o Master database\n\nCREATE LOGIN RENAN WITH PASSWORD = 'J345#$)thb';  \nCREATE LOGIN MAIA WITH PASSWORD = 'J345#$)thb';  \nCREATE LOGIN IAGO WITH PASSWORD = 'J345#$)thb';  \ngo\n\n--Trocar para o DW Database\n\nCREATE USER RENAN FOR LOGIN RENAN;  \nCREATE USER MAIA FOR LOGIN MAIA;  \nCREATE USER IAGO FOR LOGIN IAGO;  \n\nGrant select on dbo.Orders to RENAN\ngo\nGrant select on dbo.Orders to MAIA\ngo\nGrant select on dbo.Orders to IAGO\ngo\n\n--Se executar  logando a query com os usuarios criados temos o resultado para aquele user especifico.\n\nSelect * from dbo.Orders\n\n\ndrop security Policy fn_security\ngo\ndrop Function fn_securitypredicateOrder\ngo\ndrop table dbo.Orders\ngo\nDROP USER [RENAN]\nGO\nDROP USER MAIA\nGO\nDROP USER IAGO\nGO\n--trocar para o master\nDROP LOGIN [RENAN]\nGO\nDROP LOGIN MAIA\nGO\nDROP LOGIN IAGO\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "dataexjh77rhzzkvukipocws1p1",
				"poolName": "dataexjh77rhzzkvukipocws1p1"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}